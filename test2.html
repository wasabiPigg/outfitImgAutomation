<!DOCTYPE html>
<html><body>
<canvas id="canvas" width="600" height="600" style="border:solid black 1px;">
Your browser does not support canvas element.
</canvas>
<br>
<label id="saveHint">座標</label>
<script>

class PointTable // 描画用の色と座標を覚えるためのクラス
{
    constructor( _table_max = 10 ) {
        // this.color = []
        this.x = []
        this.y = []
        this.table_max = _table_max
        for ( let i=0 ; i<_table_max ; i++ ) {
            // this.color.push( `hsla( ${ i / this.table_max * 360 }, 100%, 33%, 0.8 )` )
            this.x.push( 0 )
            this.y.push( 0 )
        }
    }

    get_idx( _i ) {
        const i = ( _i < 0 ? -_i : _i ) // abs
        return i % this.table_max
    }

    // get_color( _tc ) {
    //     const r = this.get_idx( _tc.identifier )
    //     return this.color[r]
    // }

    get_xy( _tc ) {
        const r = this.get_idx( _tc.identifier )
        return { x: this.x[r], y: this.y[r] }
    }

    set_xy( _tc ){
        const r = this.get_idx( _tc.identifier )
        this.x[r] = _tc.pageX
        this.y[r] = _tc.pageY
    }
}

const xy_tbl = new PointTable()
const elm = document.querySelector( 'canvas#canvas' )
const ctx = elm.getContext( '2d' )

// changedTouches を回す。 Array ではなく Object なんですよ。 Why？
const for_touches = ( _evt, _fnc ) => {
    for ( let i=0 ; i<_evt.changedTouches.length ; i++ )
        _fnc( _evt.changedTouches[i] )
}

const ctx_draw_line = ( _t ) => {   // ctxに線を描く
    const p = xy_tbl.get_xy( _t )
    ctx.beginPath()
    ctx.moveTo( p.x, p.y )
    ctx.lineTo( _t.pageX, _t.pageY )
    ctx.lineWidth = 4
    // ctx.strokeStyle = xy_tbl.get_color( _t )
    ctx.strokeStyle = "rgb(214,215,218)"
    ctx.stroke()
    xy_tbl.set_xy( _t )
    document.getElementById("saveHint").textContent = `x: ${p.x}, y: ${p.y}`
}

elm.addEventListener( "touchstart", ( _evt ) => {
    _evt.preventDefault()
    for_touches( _evt, ( _t ) => xy_tbl.set_xy( _t ) )
}, false )

elm.addEventListener( "touchmove", ( _evt ) => {
    _evt.preventDefault()
    for_touches( _evt, ( _t ) => ctx_draw_line( _t ) )
}, false )

elm.addEventListener( "touchend", ( _evt ) => {
    _evt.preventDefault()
    for_touches( _evt, ( _t ) => {
        ctx_draw_line( _t )
        ctx.fillStyle = xy_tbl.get_color( _t )
        ctx.fillRect( _t.pageX - 4, _t.pageY - 4, 8, 8 )
    })
}, false )

//----------------
// PC用 mousemove イベントでの動作確認コード

// elm.addEventListener( "mousemove", ( _evt ) => {
//     _evt.preventDefault()
//     ctx_draw_line( { identifier: 0, pageX: _evt.pageX, pageY: _evt.pageY } )
// }, false )

</script>
</body>
</html>